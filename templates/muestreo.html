<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Muestreo - {{ muestreo.numero_qr }} - {{ muestreo.cereal }}</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#eef5ee;margin:0}
header{background:#2e7d32;color:white;padding:14px;font-size:20px;text-align:center}
.container{width:90%;margin:20px auto;background:white;padding:20px;border-radius:12px}

button{
  background:#43a047;color:white;border:none;border-radius:8px;
  padding:8px 14px;cursor:pointer
}
button:hover{background:#2e7d32}

.section{
  border:1px solid #c8e6c9;
  border-radius:10px;
  padding:15px;
  margin-bottom:15px
}

table{
  width:100%;
  border-collapse:collapse;
  margin:10px 0
}
th,td{
  border:1px solid #c8e6c9;
  padding:6px;
  font-size:13px;
  text-align:center
}
th{background:#e8f5e9}

.alerta-verde{color:#2e7d32;font-weight:bold}
.alerta-amarilla{color:#f9a825;font-weight:bold}
.alerta-roja{color:#c62828;font-weight:bold}

.modal{
  display:none;
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  background:rgba(0,0,0,.6);
  align-items:center;
  justify-content:center;
  z-index:9999
}
.modal-content{
  background:white;
  padding:20px;
  border-radius:12px;
  width:420px;
  max-height:90vh;
  overflow:auto
}

input,select{
  width:100%;
  padding:6px;
  margin-bottom:8px
}

label{
  font-weight:bold;
  display:block;
  margin-top:6px
}
</style>
</head>

<body>

<header>
Muestreo Â· {{ muestreo.numero_qr }} Â· {{ muestreo.cereal }}
</header>

<div class="container">

<button onclick="location.href='/silo/{{ muestreo.numero_qr }}'">â¬… Volver al silo</button>

<p><b>Fecha muestreo:</b> {{ muestreo.fecha_muestreo }}</p>

<hr>
<h3>Secciones del muestreo</h3>

{% for sec in ["punta","medio","final"] %}
{% set a = (analisis | selectattr("seccion","equalto",sec) | list | first) %}

<div class="section">
  <h4>{{ sec|capitalize }}</h4>

  {% if a %}
  <table>
    <tr>
      <th>Temp Â°C</th>
      <th>Hum %</th>
      <th>DaÃ±ados</th>
      <th>Quebrados</th>
      <th>M.Ext</th>
      <th>Olor %</th>
      <th>Moho %</th>
      <th>Insectos</th>
      <th>Chamico</th>
      <th>TAS (dÃ­as)</th>
      {% if muestreo.cereal in ("MaÃ­z","Trigo") %}
      <th>Grado</th>
      {% endif %}
      <th>Factor</th>
    </tr>
    <tr>
      <td>{{ a.temperatura }}</td>
      <td>{{ a.humedad }}</td>
      <td>{{ a.danados }}</td>
      <td>{{ a.quebrados }}</td>
      <td>{{ a.materia_extrana }}</td>
      <td>{{ a.olor }}</td>
      <td>{{ a.moho }}</td>
      <td>{{ "SÃ­" if a.insectos else "No" }}</td>
      <td>{{ a.chamico or 0 }}</td>
      <td>
        {% if a.tas %}
          {% if a.tas <= 7 %}
            <span class="alerta-roja">ðŸ”´ {{ a.tas }}</span>
          {% elif a.tas <= 20 %}
            <span class="alerta-amarilla">ðŸŸ¡ {{ a.tas }}</span>
          {% else %}
            <span class="alerta-verde">ðŸŸ¢ {{ a.tas }}</span>
          {% endif %}
        {% else %}
          -
        {% endif %}
      </td>
      {% if muestreo.cereal in ("MaÃ­z","Trigo") %}
      <td><b>{{ a.grado }}</b></td>
      {% endif %}
      <td><b>{{ (a.factor * 100) | round(1) }} %</b></td>
    </tr>
  </table>
  {% else %}
    <p><i>Sin anÃ¡lisis cargado</i></p>
  {% endif %}

  <button onclick="abrirAnalisis('{{ sec }}')">âž• Cargar / Editar anÃ¡lisis</button>
</div>

{% endfor %}

</div>

<!-- MODAL -->
<div id="modal" class="modal">
  <div class="modal-content">

    <h3 id="tituloModal"></h3>

    <label>Temperatura (Â°C)</label>
    <input id="temperatura">

    <label>Humedad (%)</label>
    <input id="humedad">

    {% if muestreo.cereal not in ("Soja","Girasol") %}
    <label>PH</label>
    <input id="ph">
    {% endif %}

    <label>DaÃ±ados (%)</label>
    <input id="danados">

    <label>Quebrados (%)</label>
    <input id="quebrados">

    <label>Materia extraÃ±a (%)</label>
    <input id="materia_extrana">

    <label>Olor (%)</label>
    <select id="olor">
      <option value="0">0</option>
      <option value="0.5">0.5</option>
      <option value="1">1</option>
      <option value="1.5">1.5</option>
      <option value="2">2</option>
    </select>

    <label>Moho (%)</label>
    <select id="moho">
      <option value="0">0</option>
      <option value="0.5">0.5</option>
      <option value="1">1</option>
      <option value="1.5">1.5</option>
      <option value="2">2</option>
    </select>

    <label>
      <input type="checkbox" id="insectos"> Insectos
    </label>

    <!-- CHAMICO GIRASOL -->
    <label id="labelChamico">Chamico (semillas / 100 g)</label>
    <input type="number" id="chamico" min="0" step="1" placeholder="Ej: 3">

    <br>

    <button onclick="guardarAnalisis()">ðŸ’¾ Guardar</button>
    <button onclick="cerrarModal()">Cancelar</button>

  </div>
</div>

<script>
let seccionActual = null;
const cereal = "{{ muestreo.cereal }}";

const labelChamico = document.getElementById("labelChamico");
const chamicoInput = document.getElementById("chamico");

if (cereal !== "Girasol") {
  labelChamico.style.display = "none";
  chamicoInput.style.display = "none";
}

function abrirAnalisis(seccion){
  seccionActual = seccion;
  document.getElementById("tituloModal").innerText =
    "AnÃ¡lisis - " + seccion.toUpperCase();

  ["temperatura","humedad","danados","quebrados","materia_extrana"]
    .forEach(id => document.getElementById(id).value = "");

  if(document.getElementById("ph")) document.getElementById("ph").value = "";

  olor.value = "0";
  moho.value = "0";
  insectos.checked = false;
  chamico.value = "";

  document.getElementById("modal").style.display = "flex";
}

function cerrarModal(){
  document.getElementById("modal").style.display = "none";
}

function guardarAnalisis(){
  fetch("/api/analisis_seccion", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      id_muestreo: {{ muestreo.id }},
      cereal: "{{ muestreo.cereal }}",
      seccion: seccionActual,
      temperatura: temperatura.value,
      humedad: humedad.value,
      ph: document.getElementById("ph") ? ph.value : null,
      danados: danados.value,
      quebrados: quebrados.value,
      materia_extrana: materia_extrana.value,
      olor: olor.value,
      moho: moho.value,
      insectos: insectos.checked,
      chamico: chamico.value || 0
    })
  }).then(() => location.reload());
}
</script>

</body>
</html>
