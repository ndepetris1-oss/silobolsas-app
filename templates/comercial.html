<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Comercial</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:Arial;
  background:#eef5ee;
  margin:0
}
header{
  background:#2e7d32;
  color:white;
  padding:14px;
  font-size:20px;
  text-align:center
}
.container{
  width:95%;
  margin:15px auto;
  background:white;
  padding:15px;
  border-radius:12px
}
table{
  width:100%;
  border-collapse:collapse
}
th,td{
  border:1px solid #c8e6c9;
  padding:8px;
  text-align:center;
  font-size:14px
}
th{background:#e8f5e9}
input{
  width:100%;
  padding:5px
}
button{
  background:#43a047;
  color:white;
  border:none;
  padding:6px 12px;
  border-radius:6px;
  cursor:pointer
}
button:hover{background:#2e7d32}
.small{
  font-size:12px;
  color:#555
}
.btn-comparar{
  display:inline-block;
  background:#1976d2;
  color:white;
  padding:6px 14px;
  border-radius:6px;
  text-decoration:none;
  font-size:13px;
  font-weight:bold;
  line-height:1.4;
}

.btn-comparar:hover{
  background:#1565c0;
}

.btn-bloqueado{
  background:#9e9e9e;
  color:white;
  border:none;
  padding:6px 14px;
  border-radius:6px;
  font-size:13px;
  cursor:pointer;
}
</style>
</head>

<body>

<header>ğŸ’° Comercial â€“ Precios de mercado</header>
{% set ref = mercado[0] if mercado %}

{% if mercado and ref.fecha %}
  <div style="
    margin:10px 0;
    padding:10px;
    background:#e3f2fd;
    border-left:5px solid #1976d2;
    border-radius:6px;
    font-weight:bold;
  ">
    ğŸ’± DÃ³lar oficial â€“ <b>Bluelytics</b> â€“ actualizado
    {{ ref.fecha }}
  </div>
{% endif %}

<div class="container">
<button onclick="actualizarDolar()" style="margin-bottom:10px">
  ğŸ”„ Actualizar dÃ³lar
</button>
<button onclick="actualizarPizarra()">ğŸ“Š Actualizar pizarra</button>

<div class="container">

<table>
<tr>
  <th>Cereal</th>
  <th>Pizarra auto</th>
  <th>Fuente</th>
  <th>Fecha fuente</th>
  <th>Usar manual</th>
  <th>Pizarra manual</th>
  <th>ObservaciÃ³n</th>
  <th>DÃ³lar</th>
  <th>Comparar</th>
  <th>Guardar</th>
</tr>

{% for m in mercado %}
<tr>
  <td><b>{{ m.cereal }}</b></td>
<td>
  {% if m.pizarra_auto and m.pizarra_auto > 0 %}
    {{ "{:,.0f}".format(m.pizarra_auto).replace(",", ".") }}
  {% else %}
    -
  {% endif %}
</td>

<td>
  {{ m.fuente if m.fuente else "-" }}
</td>

<td>
  {{ m.fecha_fuente if m.fecha_fuente else "-" }}
</td>
  <td>
    <input type="checkbox"
           id="usar_{{ m.cereal }}"
           {% if m.usar_manual %}checked{% endif %}>
  </td>

  <td>
    <input type="number" step="0.01"
           id="manual_{{ m.cereal }}"
           value="{{ m.pizarra_manual or '' }}">
  </td>

  <td>
    <input type="text"
           id="obs_{{ m.cereal }}"
           value="{{ m.obs_precio or '' }}">
  </td>

  <td>
    <input type="number" step="0.01"
           id="dolar_{{ m.cereal }}"
           value="{{ m.dolar or '' }}">
  </td>
<<td>
  {% if puede_comparador %}
      <a href="/comercial/{{ m.cereal }}" class="btn-comparar">
          ğŸ“Š Comparar
      </a>
  {% else %}
      <form method="POST" action="/solicitar_acceso/comparador">
          <button class="btn-bloqueado">
              ğŸ”’ Comparar
          </button>
      </form>
  {% endif %}
</td>

  <td>
    <button onclick="guardar('{{ m.cereal }}')">ğŸ’¾</button>
  </td>
</tr>
{% endfor %}
</table>

<p class="small">
âœ” Si â€œUsar manualâ€ estÃ¡ tildado, el sistema ignora la pizarra automÃ¡tica.
</p>

</div>

<script>
function guardar(cereal){
  fetch("/api/mercado/manual",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      cereal: cereal,
      usar_manual: document.getElementById("usar_"+cereal).checked,
      pizarra_manual: document.getElementById("manual_"+cereal).value,
      obs_precio: document.getElementById("obs_"+cereal).value,
      dolar: document.getElementById("dolar_"+cereal).value
    })
  }).then(r=>r.json())
    .then(()=>alert("Guardado"));
}
</script>
<script>
async function actualizarDolar(){
  if(!confirm("Â¿Actualizar dÃ³lar oficial ahora?")) return;

  try{
    const res = await fetch("/api/actualizar_dolar", {
      method: "POST"
    });

    const data = await res.json();

    if(!data.ok){
      alert(data.error || "Error al actualizar dÃ³lar");
      return;
    }

    alert("ğŸ’µ DÃ³lar actualizado: $" + data.dolar);
    location.reload();

  }catch(e){
    alert("Error de conexiÃ³n");
    console.error(e);
  }
}
</script>
<script>
async function actualizarPizarra(){
  if(!confirm("Actualizar pizarra automÃ¡tica?")) return;

  const res = await fetch("/api/actualizar_pizarra", { method:"POST" });
  const data = await res.json();

  if(data.ok){
    alert("ğŸ“Š Pizarra actualizada");
    location.reload();
  } else {
    alert("Error al actualizar pizarra");
  }
}
</script>

</body>
</html>
