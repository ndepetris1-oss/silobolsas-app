<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Control - Silo Bolsas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{font-family:Arial;background:#e8f5e9;margin:0}
header{background:#2e7d32;color:white;text-align:center;padding:14px;font-size:20px}
.container{width:95%;margin:15px auto;background:white;border-radius:14px;padding:15px}

.dashboard-nav{
  display:flex;
  gap:15px;
  flex-wrap:wrap;
  padding:15px;
  background:white;
  border-radius:14px;
  width:95%;
  margin:15px auto 0 auto;
}

.nav-btn{
  background:#1e4620;
  color:white;
  padding:10px 18px;
  border-radius:10px;
  text-decoration:none;
  font-weight:bold;
  transition:0.2s;
}

.nav-btn:hover{
  background:#2e7d32;
  transform:translateY(-2px);
}

.nav-btn.admin{
  background:#003366;
}

.toolbar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:10px
}

button,select{
  background:#43a047;
  color:white;
  border:none;
  border-radius:8px;
  padding:8px 14px;
  cursor:pointer
}
.nav-bar{
  display:flex;
  gap:12px;
  margin-bottom:15px;
  flex-wrap:wrap;
}

.nav-btn{
  background:#1b5e20;
  color:white;
  padding:10px 16px;
  border-radius:12px;
  font-weight:bold;
  border:none;
  cursor:pointer;
  text-decoration:none;
}

.nav-btn.locked{
  background:#888;
}

.nav-btn.admin{
  background:#0d47a1;
}
select{background:#c8e6c9;color:black}

button:hover{background:#2e7d32}

/* Mapa normal */
#map {
  width: 100%;
  height: 400px;
  border-radius: 12px;
}

/* Mapa en pantalla completa */
#map.fullscreen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 9999;
  border-radius: 0;
}

table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #c8e6c9;text-align:center}
th{background:#a5d6a7;cursor:pointer}

.humedo{background:#ffebee;color:#b71c1c;font-weight:bold}
.estado-activo{color:#2e7d32;font-weight:bold}
.estado-extracci√≥n-parcial{color:#f9a825;font-weight:bold}
.estado-extra√≠do{color:#b71c1c;font-weight:bold}
.estado-humedo{
  background:#ffebee;
  color:#b71c1c;
  font-weight:bold;
}

.tas-alerta{
  background:#ffebee;
  color:#b71c1c;
  font-weight:bold;
}
</style>
</head>

<body>

<header>PANEL DE CONTROL ¬∑ SILO BOLSAS</header>
<div class="nav-bar">

    <!-- FORM -->
    {% if puede_form %}
        <a href="/form" class="nav-btn">üìù Form</a>
    {% else %}
        <form method="POST" action="/solicitar_acceso/form">
            <button class="nav-btn locked">üîí Form</button>
        </form>
    {% endif %}

    <!-- COMERCIAL -->
    {% if puede_comercial %}
        <a href="/comercial" class="nav-btn">üìä Comercial</a>
    {% else %}
        <form method="POST" action="/solicitar_acceso/comercial">
            <button class="nav-btn locked">üîí Comercial</button>
        </form>
    {% endif %}

    <!-- COMPARADOR -->
    {% if puede_comparador %}
        <a href="/comparador" class="nav-btn">üìà Comparador</a>
    {% else %}
        <form method="POST" action="/solicitar_acceso/comparador">
            <button class="nav-btn locked">üîí Comparador</button>
        </form>
    {% endif %}

    <!-- ADMIN -->
    {% if puede_admin %}
        <a href="/admin/usuarios" class="nav-btn admin">‚öô Administraci√≥n</a>
    {% else %}
        <form method="POST" action="/solicitar_acceso/admin">
            <button class="nav-btn locked admin">üîí Administraci√≥n</button>
        </form>
    {% endif %}

</div>

<div class="container">

<button id="btnMapa"
        onclick="toggleMapa()"
        style="
          position:absolute;
          z-index:10000;
          margin:10px;
          padding:8px 12px;
          border-radius:8px;
          border:none;
          background:#1976d2;
          color:white;
          font-weight:bold;
          cursor:pointer;
        ">
  üó∫ Pantalla completa
</button>

<div id="map"></div>

<table>
<thead>
<tr>
  <th onclick="ordenar('qr')">QR ‚¨ç</th>
  <th>Cereal</th>
  <th>Estado grano</th>
  <th>Estado silo</th>
  <th onclick="ordenar('confeccion')">Confecci√≥n ‚¨ç</th>
  <th onclick="ordenar('grado')">Grado ‚¨ç</th>
  <th onclick="ordenar('factor')">Factor ‚¨ç</th>
  <th onclick="ordenar('tas')">TAS m√≠n ‚¨ç</th>
  <th onclick="ordenar('extraccion')">Extracci√≥n estimada ‚¨ç</th>
  <th>Eventos</th>
  <th>Acci√≥n</th>
</tr>

<tr>
  <th></th>

  <th>
    <select onchange="setFiltro('cereal', this.value)">
      <option value="">Todos</option>
      <option>Ma√≠z</option>
      <option>Soja</option>
      <option>Trigo</option>
      <option>Girasol</option>
    </select>
  </th>

  <th>
    <select onchange="setFiltro('estado_grano', this.value)">
      <option value="">Todos</option>
      <option>Seco</option>
      <option>Humedo</option>
    </select>
  </th>

  <th>
    <select onchange="setFiltro('estado_silo', this.value)">
      <option value="">Todos</option>
      <option>Activo</option>
      <option>Extracci√≥n parcial</option>
      <option>Extra√≠do</option>
    </select>
  </th>

  <th></th>
  <th></th>
  <th></th>
  <th></th>
  <th></th>

  <th>
    <select onchange="setFiltro('eventos', this.value)">
      <option value="">Todos</option>
      <option value="no">No</option>
      <option value="si">Con eventos</option>
    </select>
  </th>

  <th></th>
</tr>
</thead>

<tbody id="tabla"></tbody>
</table>

</div>
<script>
function toggleMapa(){
  const mapDiv = document.getElementById("map");
  mapDiv.classList.toggle("fullscreen");

  // Leaflet necesita recalcular tama√±o
  setTimeout(() => {
    if(window.map){
      map.invalidateSize();
    }
  }, 300);
}
</script>

<script>
/* ===== DATOS ===== */
const registros = {{ registros | tojson | safe }};
let visibles = [...registros];
const tbody = document.getElementById("tabla");

/* ===== MAPA ===== */
const map = L.map('map', { zoomControl:false });
map.setView([-34.6, -58.4], 6);

L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  { attribution:'¬© Esri' }
).addTo(map);

setTimeout(() => map.invalidateSize(true), 300);

let markers = [];

function icono(c){
  let color="blue";
  if(c==="Ma√≠z") color="orange";
  if(c==="Soja") color="yellow";
  if(c==="Trigo") color="#bdbdbd";
  if(c==="Girasol") color="black";
  return L.divIcon({ html:`<div style="background:${color};width:14px;height:14px;border-radius:50%;border:2px solid white"></div>` });
}

/* ===== RENDER ===== */
function render(){
  tbody.innerHTML="";
  markers.forEach(m=>map.removeLayer(m));
  markers=[];

  let bounds=[];

  visibles.forEach(r=>{
    tbody.innerHTML+=`
      <tr>
        <td>${r.numero_qr}</td>
        <td>${r.cereal}</td>
        <td class="${r.estado_grano === 'Humedo' ? 'estado-humedo' : ''}">
          ${r.estado_grano ?? '-'}
        </td>
        <td>${r.estado_silo ?? 'Activo'}</td>
        <td>${r.fecha_confeccion}</td>
        <td>${r.grado ?? '-'}</td>
        <td>${r.factor ? (r.factor*100).toFixed(2)+'%' : '-'}</td>
        <td class="${r.tas_min !== null && r.tas_min <= 30 ? 'tas-alerta' : ''}">
          ${r.tas_min ?? '-'}
        </td>
        <td>${r.fecha_extraccion_estimada ?? '-'}</td>
        <td>${r.eventos>0 ? r.eventos : 'No'}</td>
        <td>
  <button
    onclick="location.href='/silo/${r.numero_qr}'"
    style="margin-bottom:6px">
    üîç Ver
  </button>

  <br>

  ${
    r.estado_silo !== "Extra√≠do"
      ? `<button
            onclick="confirmarExtraccion('${r.numero_qr}')"
            style="background:#c62828;color:white">
            üóë Marcar como extra√≠do
         </button>`
      : `<span style="color:#388e3c;font-weight:bold">‚úî Extra√≠do</span>`
  }
</td>
      </tr>
    `;

    if(r.lat && r.lon){
      const m=L.marker([r.lat,r.lon],{icon:icono(r.cereal)}).addTo(map);
      markers.push(m);
      bounds.push([r.lat,r.lon]);
    }
  });

  if(bounds.length) map.fitBounds(bounds,{padding:[30,30]});
}

/* ===== FILTROS + ORDEN EXCEL ===== */
const filtros = {
  cereal:"",
  estado_grano:"",
  estado_silo:"",
  eventos:"",
  orden:""
};

function setFiltro(campo,valor){
  filtros[campo]=valor;
  aplicarFiltros();
}

function ordenar(campo){
  filtros.orden = campo;
  aplicarFiltros();
}

function aplicarFiltros(){
  visibles = registros.filter(r=>{
    if(filtros.cereal && r.cereal!==filtros.cereal) return false;
    if(filtros.estado_grano && r.estado_grano!==filtros.estado_grano) return false;
    if(filtros.estado_silo && r.estado_silo!==filtros.estado_silo) return false;
    if(filtros.eventos==="si" && r.eventos===0) return false;
    if(filtros.eventos==="no" && r.eventos>0) return false;
    return true;
  });

  switch(filtros.orden){
    case "qr": visibles.sort((a,b)=>a.numero_qr.localeCompare(b.numero_qr)); break;
    case "confeccion": visibles.sort((a,b)=>new Date(a.fecha_confeccion)-new Date(b.fecha_confeccion)); break;
    case "grado": visibles.sort((a,b)=>(a.grado??99)-(b.grado??99)); break;
    case "factor": visibles.sort((a,b)=>(a.factor??999)-(b.factor??999)); break;
    case "tas": visibles.sort((a,b)=>(a.tas_min??9999)-(b.tas_min??9999)); break;
    case "extraccion":
      visibles.sort((a,b)=>{
        if(!a.fecha_extraccion_estimada) return 1;
        if(!b.fecha_extraccion_estimada) return -1;
        return new Date(a.fecha_extraccion_estimada)-new Date(b.fecha_extraccion_estimada);
      });
      break;
  }

  render();
}

/* INIT */
render();
</script>
<script>
async function confirmarExtraccion(qr){
  if(!confirm(
    "‚ö†Ô∏è ATENCI√ìN\n\n" +
    "Esta acci√≥n es administrativa.\n" +
    "Usar solo si el silo fue extra√≠do f√≠sicamente y no se registr√≥ en campo.\n\n" +
    "¬øConfirmar extracci√≥n del silo " + qr + "?"
  )) return;

  const res = await fetch("/api/extraccion",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      numero_qr: qr,
      estado_silo: "Extra√≠do"
    })
  });

  const data = await res.json();

  if(!data.ok){
    alert(data.error || "Error al marcar como extra√≠do");
    return;
  }

  alert("‚úî Silo marcado como extra√≠do");
  location.reload();
}
</script>

</body>
</html>
