<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Silo Bolsas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background-color: #e8f5e9;
  margin: 0;
  color: #2e7d32;
}
header {
  background-color: #2e7d32;
  color: white;
  text-align: center;
  padding: 14px;
  font-size: 20px;
  font-weight: bold;
}
.container {
  width: 95%;
  margin: 15px auto;
  background: white;
  border-radius: 14px;
  padding: 15px;
}
.toolbar {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 10px;
}
button {
  background-color: #43a047;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  cursor: pointer;
}
.danger { background-color: #d32f2f; }

#map {
  height: 420px;
  border-radius: 12px;
  margin-bottom: 15px;
}

table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  padding: 8px;
  border-bottom: 1px solid #c8e6c9;
  text-align: center;
}
th { background-color: #a5d6a7; }

.estado-humedo {
  background:#ffebee;
  color:#c62828;
  font-weight:bold;
}
.estado-seco {
  background:#e8f5e9;
  color:#2e7d32;
}

/* MODAL */
.modal {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  z-index:999;
}
.modal-content {
  background:white;
  max-width:600px;
  margin:5% auto;
  padding:20px;
  border-radius:14px;
}
.modal label { display:block; margin-top:8px }
.modal input { width:100%; padding:6px }
</style>
</head>

<body>

<header>PANEL DE CONTROL ¬∑ SILO BOLSAS</header>

<div class="container">

<div class="toolbar">
  <button onclick="location.href='/form'">‚ûï Nuevo registro</button>
  <button onclick="window.location.href='/api/export'">üì§ Exportar Excel</button>
  <button onclick="centrarUsuario()">üìç Mi ubicaci√≥n</button>
  <button onclick="pantallaCompleta()">üñ•Ô∏è Pantalla completa</button>
  <button class="danger" onclick="borrarTodo()">üßπ Limpiar base</button>
</div>

<div id="map"></div>

<table>
<thead>
<tr>
<th>QR</th>
<th>Cereal</th>
<th>Estado</th>
<th>Fecha confecci√≥n</th>
<th>D√≠as sin muestra</th>
<th>Factor</th>
<th>Acci√≥n</th>
</tr>
</thead>
<tbody>
{% for r in registros %}
<tr onclick="abrirModal('{{ r.numero_qr }}','{{ r.cereal }}')">
<td>{{ r.numero_qr }}</td>
<td>{{ r.cereal }}</td>
<td class="{{ 'estado-humedo' if r.estado == 'Humedo' else 'estado-seco' }}">
  {{ r.estado }}
</td>
<td>{{ r.fecha_confeccion }}</td>
<td>{{ r.dias_sin_muestra or "-" }}</td>
<td>{{ r.factor or "-" }}</td>
<td>
  <button class="danger"
    onclick="event.stopPropagation(); borrar('{{ r.numero_qr }}')">
    üóëÔ∏è
  </button>
</td>
</tr>
{% endfor %}
</tbody>
</table>

</div>

<!-- MODAL ANALISIS -->
<div id="modal" class="modal">
<div class="modal-content">
<h3 id="titulo"></h3>

<form id="formAnalisis">
<input type="hidden" name="numero_qr" id="qr">
<div id="campos"></div>
<br>
<button type="submit">üíæ Guardar an√°lisis</button>
<button type="button" onclick="cerrar()">Cancelar</button>
</form>

<div id="resultado"></div>
</div>
</div>

<script>
/* MAPA */
const map = L.map('map');
L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
).addTo(map);

const bounds = [];
{% for r in registros %}
{% if r.lat and r.lon %}
L.marker([{{ r.lat }},{{ r.lon }}]).addTo(map);
bounds.push([{{ r.lat }},{{ r.lon }}]);
{% endif %}
{% endfor %}
if(bounds.length) map.fitBounds(bounds,{padding:[30,30]});

/* TOOLBAR */
function centrarUsuario(){
  navigator.geolocation.getCurrentPosition(p=>{
    map.setView([p.coords.latitude,p.coords.longitude],16);
  });
}
function pantallaCompleta(){
  const el=document.getElementById("map");
  if(el.requestFullscreen){
    el.requestFullscreen();
    setTimeout(()=>map.invalidateSize(),300);
  }
}

/* MODAL */
let cerealActual="";

function abrirModal(qr,cereal){
  cerealActual = cereal
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g,"");

  document.getElementById("modal").style.display="block";
  document.getElementById("qr").value = qr;
  document.getElementById("titulo").innerText =
    "An√°lisis comercial ¬∑ " + cereal + " ¬∑ " + qr;

  document.getElementById("campos").innerHTML = camposAnalisis(cerealActual);
  document.getElementById("resultado").innerHTML="";
}

function cerrar(){
  document.getElementById("modal").style.display="none";
}

/* CAMPOS ANALISIS */
function camposAnalisis(c){
if(c==="maiz") return `
<label>Humedad (%)</label><input name="humedad" type="number" step="0.1">
<label>Peso hectol√≠trico</label><input name="ph" type="number" step="0.1">
<label>Granos da√±ados (%)</label><input name="danados" type="number" step="0.1">
<label>Quebrados (%)</label><input name="quebrados" type="number" step="0.1">
<label>Materia extra√±a (%)</label><input name="extra√±a" type="number" step="0.1">
`;
if(c==="trigo") return `
<label>Humedad (%)</label><input name="humedad" type="number" step="0.1">
<label>Peso hectol√≠trico</label><input name="ph" type="number" step="0.1">
<label>Da√±ados totales (%)</label><input name="danados" type="number" step="0.1">
<label>Panza blanca (%)</label><input name="panza" type="number" step="0.1">
<label>Carb√≥n (%)</label><input name="carbon" type="number" step="0.1">
`;
if(c==="soja") return `
<label>Humedad (%)</label><input name="humedad" type="number" step="0.1">
<label>Materia extra√±a (%)</label><input name="extra√±a" type="number" step="0.1">
<label>Granos da√±ados (%)</label><input name="danados" type="number" step="0.1">
<label>Granos verdes (%)</label><input name="verdes" type="number" step="0.1">
`;
if(c==="girasol") return `
<label>Humedad (%)</label><input name="humedad" type="number" step="0.1">
<label>Materia extra√±a (%)</label><input name="extra√±a" type="number" step="0.1">
<label>Granos da√±ados (%)</label><input name="danados" type="number" step="0.1">
`;
return "";
}

/* GUARDAR ANALISIS */
document.getElementById("formAnalisis").onsubmit = async e=>{
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target));

  const res = await fetch("/api/analisis",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      numero_qr:data.numero_qr,
      cereal:cerealActual,
      datos:data
    })
  });

  const r = await res.json();
  document.getElementById("resultado").innerHTML =
    `<hr><b>Grado:</b> ${r.grado}<br><b>Factor:</b> ${r.factor}`;
};

/* BORRADOS */
async function borrar(qr){
  if(!confirm("Eliminar "+qr+"?")) return;
  await fetch("/api/delete",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({numero_qr:qr})});
  location.reload();
}
async function borrarTodo(){
  if(!confirm("Eliminar TODOS los registros?")) return;
  await fetch("/api/delete_all",{method:"POST"});
  location.reload();
}
</script>

</body>
</html>
