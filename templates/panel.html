<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Silo Bolsas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body { font-family: Arial; background:#e8f5e9; margin:0 }
header { background:#2e7d32; color:white; padding:12px; text-align:center }
.container { width:95%; margin:10px auto; background:white; padding:10px; border-radius:12px }
.toolbar button { margin:5px; padding:8px 12px; border:none; border-radius:6px; background:#43a047; color:white }
#map { height:400px; border-radius:10px }
table { width:100%; border-collapse:collapse; margin-top:10px }
th,td { padding:6px; text-align:center; border-bottom:1px solid #c8e6c9 }
th { background:#a5d6a7 }
.estado-humedo { background:#ffebee; color:#c62828; font-weight:bold }
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.5) }
.modal-content { background:white; max-width:500px; margin:5% auto; padding:20px; border-radius:12px }
</style>
</head>

<body>

<header>PANEL DE CONTROL · SILO BOLSAS</header>

<div class="container">
<div class="toolbar">
<button onclick="location.href='/form'">Nuevo registro</button>
<button onclick="location.href='/api/export'">Exportar Excel</button>
</div>

<div id="map"></div>

<table>
<thead>
<tr>
<th>QR</th><th>Cereal</th><th>Estado</th>
<th>Fecha confección</th><th>Grado</th><th>Factor</th>
</tr>
</thead>
<tbody>
{% for r in registros %}
<tr onclick="abrir('{{r.numero_qr}}','{{r.cereal}}')">
<td>{{r.numero_qr}}</td>
<td>{{r.cereal}}</td>
<td class="{{ 'estado-humedo' if r.estado=='Humedo' else '' }}">{{r.estado}}</td>
<td>{{r.fecha_confeccion}}</td>
<td>{{r.grado or '-'}}</td>
<td>{{r.factor or '-'}}</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>

<div id="modal" class="modal">
<div class="modal-content">
<h3 id="titulo"></h3>

<form id="formAnalisis">
<input type="hidden" name="numero_qr" id="qr">

<label>Humedad (%)</label>
<input name="humedad" type="number" step="0.1">

<label>Peso hectolítrico</label>
<input name="ph" type="number" step="0.1">

<button type="submit">Guardar análisis</button>
<button type="button" onclick="cerrar()">Cancelar</button>
</form>

<div id="resultado"></div>
</div>
</div>

<script>
let cerealActual="";

function abrir(qr,cereal){
  cerealActual=cereal;
  document.getElementById("qr").value=qr;
  document.getElementById("titulo").innerText="Análisis · "+cereal+" · "+qr;
  document.getElementById("modal").style.display="block";
}

function cerrar(){
  document.getElementById("modal").style.display="none";
}

document.getElementById("formAnalisis").onsubmit=async e=>{
  e.preventDefault();
  const data=Object.fromEntries(new FormData(e.target));

  const res=await fetch("/api/analisis",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      numero_qr:data.numero_qr,
      cereal:cerealActual,
      datos:data
    })
  });

  const r=await res.json();

  document.getElementById("resultado").innerHTML=
    `<b>Grado:</b> ${r.grado}<br><b>Factor:</b> ${r.factor}`;

  setTimeout(()=>location.reload(),800);
};
</script>

</body>
</html>
