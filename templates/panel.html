<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Silo Bolsas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background-color: #e8f5e9;
  margin: 0;
  color: #2e7d32;
}
header {
  background-color: #2e7d32;
  color: white;
  text-align: center;
  padding: 14px;
  font-size: 20px;
  font-weight: bold;
}
.container {
  width: 95%;
  margin: 15px auto;
  background: white;
  border-radius: 14px;
  padding: 15px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.toolbar {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 10px;
}
button {
  background-color: #43a047;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  cursor: pointer;
  font-size: 14px;
}
button:hover { background-color: #2e7d32; }
.danger { background-color: #d32f2f; }

#map {
  height: 420px;
  border-radius: 12px;
  margin-bottom: 15px;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}
th, td {
  padding: 8px;
  border-bottom: 1px solid #c8e6c9;
  text-align: center;
}
th { background-color: #a5d6a7; }

.estado-humedo {
  background:#ffebee;
  color:#c62828;
  font-weight:bold;
}
.estado-seco {
  background:#e8f5e9;
  color:#2e7d32;
}

.alerta-OK { color:#2e7d32 }
.alerta-ATENCION { color:#f9a825 }
.alerta-ALERTA { color:#ef6c00 }
.alerta-URGENTE { color:#c62828; font-weight:bold }

/* MODAL */
.modal {
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,.5); z-index:999
}
.modal-content {
  background:white; max-width:600px;
  margin:4% auto; padding:20px; border-radius:14px
}
.modal label { display:block; margin-top:8px }
.modal input { width:100%; padding:6px }
</style>
</head>

<body>

<header>PANEL DE CONTROL Â· SILO BOLSAS</header>

<div class="container">

<div class="toolbar">
  <button onclick="location.href='/form'">âž• Nuevo registro</button>
  <button onclick="window.location.href='/api/export'">ðŸ“¤ Exportar Excel</button>
</div>

<div id="map"></div>

<table>
<thead>
<tr>
<th>QR</th>
<th>Cereal</th>
<th>Estado</th>
<th>Fecha confecciÃ³n</th>
<th>DÃ­as sin muestra</th>
<th>Factor</th>
<th>Alerta</th>
</tr>
</thead>
<tbody>
{% for r in registros %}
<tr onclick="abrirModal('{{ r.numero_qr }}','{{ r.cereal }}')">
<td>{{ r.numero_qr }}</td>
<td>{{ r.cereal }}</td>
<td class="{{ 'estado-humedo' if r.estado == 'Humedo' else 'estado-seco' }}">
  {{ r.estado }}
</td>
<td>{{ r.fecha_confeccion }}</td>
<td>{{ r.dias_sin_muestra or "-" }}</td>
<td>{{ r.factor or "-" }}</td>
<td class="alerta-{{ r.alerta or 'OK' }}">{{ r.alerta or "OK" }}</td>
</tr>
{% endfor %}
</tbody>
</table>

</div>

<!-- MODAL ANALISIS COMERCIAL -->
<div id="modal" class="modal">
<div class="modal-content">
<h3 id="titulo"></h3>

<form id="formAnalisis">
<input type="hidden" name="numero_qr" id="qr">

<div id="campos"></div>

<br>
<button type="submit">ðŸ’¾ Guardar anÃ¡lisis</button>
<button type="button" onclick="cerrar()">Cancelar</button>
</form>

<div id="resultado"></div>
</div>
</div>

<script>
/* =============== MAPA =============== */
const map = L.map('map');
L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
).addTo(map);

const bounds = [];
{% for r in registros %}
{% if r.lat and r.lon %}
L.marker([{{ r.lat }},{{ r.lon }}])
.addTo(map)
.bindPopup("{{ r.numero_qr }} Â· {{ r.cereal }}");
bounds.push([{{ r.lat }},{{ r.lon }}]);
{% endif %}
{% endfor %}

if(bounds.length) map.fitBounds(bounds,{padding:[30,30]});

/* =============== MODAL =============== */
let cerealActual = "";

function abrirModal(qr, cereal) {
  cerealActual = cereal.toLowerCase();
  document.getElementById("modal").style.display="block";
  document.getElementById("qr").value = qr;
  document.getElementById("titulo").innerText =
    "AnÃ¡lisis comercial Â· " + cereal + " Â· " + qr;

  document.getElementById("campos").innerHTML =
    camposAnalisis(cerealActual);

  document.getElementById("resultado").innerHTML = "";
}

function cerrar() {
  document.getElementById("modal").style.display="none";
}

/* =============== CAMPOS ANALISIS =============== */
function camposAnalisis(c) {

if(c === "maiz") return `
<label>Humedad (%)</label><input name="humedad" type="number" step="0.1">
<label>Peso hectolÃ­trico</label><input name="ph" type="number" step="0.1">
<label>Granos daÃ±ados (%)</label><input name="danados" type="number" step="0.1">
<label>Quebrados (%)</label><input name="quebrados" type="number" step="0.1">
<label>Materia extraÃ±a (%)</label><input name="extraÃ±a" type="number" step="0.1">
`;

if(c === "soja") return `
<label>Humedad (%)</label><input name="humedad" type="number" step="0.1">
<label>Materia extraÃ±a (%)</label><input name="extraÃ±a" type="number" step="0.1">
<label>Granos daÃ±ados (%)</label><input name="danados" type="number" step="0.1">
<label>Granos verdes (%)</label><input name="verdes" type="number" step="0.1">
`;

if(c === "trigo") return `
<label>Humedad (%)</label><input name="humedad" type="number" step="0.1">
<label>Peso hectolÃ­trico</label><input name="ph" type="number" step="0.1">
<label>DaÃ±ados totales (%)</label><input name="danados" type="number" step="0.1">
<label>Panza blanca (%)</label><input name="panza" type="number" step="0.1">
<label>CarbÃ³n (%)</label><input name="carbon" type="number" step="0.1">
`;

if(c === "girasol") return `
<label>Humedad (%)</label><input name="humedad" type="number" step="0.1">
<label>Materia extraÃ±a (%)</label><input name="extraÃ±a" type="number" step="0.1">
<label>Granos daÃ±ados (%)</label><input name="danados" type="number" step="0.1">
`;

return "";
}

/* =============== GUARDAR ANALISIS =============== */
document.getElementById("formAnalisis").onsubmit = async e => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target));

  const res = await fetch("/api/analisis", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      numero_qr: data.numero_qr,
      cereal: cerealActual,
      datos: data
    })
  });

  const r = await res.json();

  document.getElementById("resultado").innerHTML = `
    <hr>
    <b>Grado:</b> ${r.grado}<br>
    <b>Factor:</b> ${r.factor}
  `;
};
</script>

</body>
</html>
