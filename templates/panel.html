<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Panel</title>
</head>
<body>

<table border="1">
<tr>
<th>QR</th><th>Cereal</th><th>Estado</th>
<th>Fecha confección</th><th>Grado</th><th>Factor</th>
</tr>
{% for r in registros %}
<tr onclick="abrir('{{r.numero_qr}}','{{r.cereal}}')">
<td>{{r.numero_qr}}</td>
<td>{{r.cereal}}</td>
<td>{{r.estado}}</td>
<td>{{r.fecha_confeccion}}</td>
<td>{{r.grado or "-"}}</td>
<td>{{r.factor or "-"}}</td>
</tr>
{% endfor %}
</table>

<div id="modal" style="display:none">
<form id="f">
<input type="hidden" name="numero_qr">
<label>PH</label><input name="ph">
<label>Dañados</label><input name="danados">
<label>Quebrados</label><input name="quebrados">
<label>Materia extraña</label><input name="me">
<button>Guardar</button>
</form>
<div id="res"></div>
</div>

<script>
let cereal=""
function abrir(q,c){
  cereal=c
  f.numero_qr.value=q
  modal.style.display="block"
}

f.onsubmit=async e=>{
  e.preventDefault()
  const d=Object.fromEntries(new FormData(f))
  const r=await fetch("/api/analisis",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      numero_qr:d.numero_qr,
      cereal:cereal,
      datos:d
    })
  })
  const j=await r.json()
  res.innerHTML=`Grado: ${j.grado} | Factor: ${j.factor}`
  setTimeout(()=>location.reload(),800)
}
</script>

</body>
</html>
