<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Control - Silo Bolsas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{font-family:Arial;background:#e8f5e9;margin:0}
header{
  background:#2e7d32;color:white;text-align:center;
  padding:14px;font-size:20px;font-weight:bold
}
.container{
  width:96%;margin:15px auto;background:white;
  border-radius:14px;padding:15px;
  box-shadow:0 4px 10px rgba(0,0,0,.2)
}

.toolbar, .filters{
  display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px
}

button, select{
  background:#43a047;color:white;border:none;
  border-radius:8px;padding:8px 12px;
  cursor:pointer;font-size:14px
}
select{background:#66bb6a}
button:hover{background:#2e7d32}

#map{
  height:420px;border-radius:12px;margin-bottom:15px
}

table{width:100%;border-collapse:collapse;font-size:13px}
th,td{
  padding:6px;border-bottom:1px solid #c8e6c9;
  text-align:center
}
th{background:#a5d6a7}

tr[data-rec="extraer"]{background:#ffebee}
tr[data-rec="remuestrear"]{background:#fffde7}

.badge{
  padding:4px 8px;border-radius:6px;
  font-weight:bold;font-size:12px
}
.verde{background:#c8e6c9;color:#1b5e20}
.amarillo{background:#fff9c4;color:#f57f17}
.rojo{background:#ffcdd2;color:#b71c1c}
</style>
</head>

<body>

<header>PANEL DE CONTROL ¬∑ SILO BOLSAS</header>

<div class="container">

<div class="toolbar">
  <button onclick="location.href='/form'">‚ûï Nuevo silo</button>
  <button onclick="location.href='/api/export'">üì§ Exportar CSV</button>
  <button onclick="centrar()">üìç Mi ubicaci√≥n</button>
</div>

<div class="filters">
  <select id="fCereal" onchange="filtrar()">
    <option value="">Cereal</option>
    <option>Ma√≠z</option>
    <option>Trigo</option>
    <option>Soja</option>
    <option>Girasol</option>
  </select>

  <select id="fEstado" onchange="filtrar()">
    <option value="">Estado</option>
    <option>Seco</option>
    <option>Humedo</option>
  </select>

  <select id="fRec" onchange="filtrar()">
    <option value="">Recomendaci√≥n</option>
    <option value="normal">Normal</option>
    <option value="remuestrear">Remuestrear</option>
    <option value="extraer">Extraer</option>
  </select>

  <button onclick="ordenarAntiguos()">üïí M√°s antiguos</button>
  <button onclick="soloCriticos()">üî¥ Solo cr√≠ticos</button>
  <button onclick="resetFiltros()">‚ôª Reset</button>
</div>

<div id="map"></div>

<table id="tabla">
<thead>
<tr>
  <th>QR</th>
  <th>Cereal</th>
  <th>Estado</th>
  <th>D√≠as</th>
  <th>TAS min</th>
  <th>Recomendaci√≥n</th>
  <th>Grado</th>
  <th>Factor</th>
  <th>Acci√≥n</th>
</tr>
</thead>

<tbody>
{% for r in registros %}
<tr
  data-cereal="{{ r.cereal }}"
  data-estado="{{ r.estado }}"
  data-rec="{{ r.recomendacion }}"
  data-dias="{{ r.dias_confeccion }}"
>
  <td>{{ r.numero_qr }}</td>
  <td>{{ r.cereal }}</td>
  <td>{{ r.estado }}</td>
  <td>{{ r.dias_confeccion }}</td>

  <td>
    {% if r.tas_min %}
      {{ r.tas_min }}
    {% else %}
      -
    {% endif %}
  </td>

  <td>
    {% if r.recomendacion == "extraer" %}
      <span class="badge rojo">üî¥ Extraer</span>
    {% elif r.recomendacion == "remuestrear" %}
      <span class="badge amarillo">üü° Remuestrear</span>
    {% else %}
      <span class="badge verde">üü¢ Normal</span>
    {% endif %}
  </td>

  <td>{{ r.grado if r.grado is not none else "-" }}</td>

  <td>
    {% if r.factor %}
      {{ r.factor }} %
    {% else %}
      -
    {% endif %}
  </td>

  <td>
    <button onclick="location.href='/silo/{{ r.numero_qr }}'">
      üìä Ver
    </button>
  </td>
</tr>
{% endfor %}
</tbody>
</table>

</div>

<script>
const registros = {{ registros | tojson }};
const map = L.map('map');

L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  { attribution:'¬© Esri' }
).addTo(map);

let bounds = [];

registros.forEach(r=>{
  if(r.lat && r.lon){
    L.marker([r.lat,r.lon])
      .addTo(map)
      .bindPopup(
        `<b>${r.numero_qr}</b><br>
         ${r.cereal}<br>
         ${r.recomendacion}`
      );
    bounds.push([r.lat,r.lon]);
  }
});

if(bounds.length){
  map.fitBounds(bounds,{padding:[30,30]});
}else{
  map.setView([-34.6,-58.4],6);
}

function centrar(){
  navigator.geolocation.getCurrentPosition(pos=>{
    map.setView([pos.coords.latitude,pos.coords.longitude],16);
  });
}

function filtrar(){
  const c = fCereal.value;
  const e = fEstado.value;
  const r = fRec.value;

  document.querySelectorAll("#tabla tbody tr").forEach(tr=>{
    tr.style.display =
      (!c || tr.dataset.cereal===c) &&
      (!e || tr.dataset.estado===e) &&
      (!r || tr.dataset.rec===r)
      ? "" : "none";
  });
}

function soloCriticos(){
  fRec.value="extraer";
  filtrar();
}

function ordenarAntiguos(){
  const tbody=document.querySelector("#tabla tbody");
  [...tbody.rows]
    .sort((a,b)=>b.dataset.dias-a.dataset.dias)
    .forEach(r=>tbody.appendChild(r));
}

function resetFiltros(){
  fCereal.value="";
  fEstado.value="";
  fRec.value="";
  filtrar();
}
</script>

</body>
</html>
