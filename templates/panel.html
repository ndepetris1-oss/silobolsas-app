<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel Silo Bolsas</title>
<style>
body{font-family:Arial;background:#e8f5e9}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#a5d6a7}
tr:hover{background:#f1f8e9;cursor:pointer}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5)}
.modal-content{background:#fff;margin:5% auto;padding:20px;width:400px}
</style>
</head>

<body>

<h2>Panel de Silo Bolsas</h2>

<button onclick="location.href='/form'">Nuevo Silo</button>
<button onclick="location.href='/api/export'">Exportar</button>

<table>
<tr>
<th>QR</th><th>Cereal</th><th>Estado</th><th>Factor total</th>
</tr>
{% for r in registros %}
<tr onclick="abrir('{{r.numero_qr}}','{{r.cereal}}')">
<td>{{r.numero_qr}}</td>
<td>{{r.cereal}}</td>
<td>{{r.estado}}</td>
<td>{{r.factor or '-'}}</td>
</tr>
{% endfor %}
</table>

<div class="modal" id="modal">
<div class="modal-content">
<h3 id="titulo"></h3>

<select id="seccion">
<option value="punta">Punta</option>
<option value="medio">Medio</option>
<option value="final">Final</option>
</select>

<input id="temperatura" placeholder="Temperatura °C">
<input id="humedad" placeholder="Humedad %">

<input id="ph" placeholder="PH (solo maíz)">
<input id="danados" placeholder="Dañados %">
<input id="quebrados" placeholder="Quebrados %">
<input id="me" placeholder="Materia extraña %">

<label><input type="checkbox" id="olor"> Olor</label>
<label><input type="checkbox" id="moho"> Moho</label>
<label><input type="checkbox" id="insectos"> Insectos</label>
<label><input type="checkbox" id="chamico"> Chamico</label>

<br><br>
<button onclick="guardar()">Guardar muestreo</button>
<button onclick="cerrar()">Cerrar</button>

<div id="res"></div>
</div>
</div>

<script>
let qr="", cereal="";

function abrir(q,c){
  qr=q; cereal=c.toLowerCase();
  document.getElementById("titulo").innerText=`${q} - ${c}`;
  document.getElementById("modal").style.display="block";
}

function cerrar(){
  document.getElementById("modal").style.display="none";
}

async function guardar(){
  const datos={
    ph:parseFloat(ph.value)||0,
    danados:parseFloat(danados.value)||0,
    quebrados:parseFloat(quebrados.value)||0,
    me:parseFloat(me.value)||0
  };

  const r=await fetch("/api/muestreo",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      numero_qr:qr,
      cereal:cereal,
      seccion:seccion.value,
      temperatura:parseFloat(temperatura.value),
      humedad:parseFloat(humedad.value),
      datos:datos,
      olor:olor.checked?1:0,
      moho:moho.checked?1:0,
      insectos:insectos.checked?1:0,
      chamico:chamico.checked?1:0
    })
  });

  const j=await r.json();
  res.innerText=`Factor muestra: ${j.factor}`;
  setTimeout(()=>location.reload(),800);
}
</script>

</body>
</html>
