<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Silo Bolsas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#e8f5e9;
  margin:0;
  color:#2e7d32;
}

header{
  background:#2e7d32;
  color:white;
  text-align:center;
  padding:14px;
  font-size:20px;
  font-weight:bold;
}

.container{
  width:95%;
  margin:15px auto;
  background:white;
  border-radius:14px;
  padding:15px;
  box-shadow:0 4px 10px rgba(0,0,0,.2);
}

.toolbar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:10px;
}

button{
  background:#43a047;
  color:white;
  border:none;
  border-radius:8px;
  padding:8px 14px;
  cursor:pointer;
}

#map{
  height:420px;
  border-radius:12px;
  margin-bottom:15px;
}

table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  padding:8px;
  border-bottom:1px solid #c8e6c9;
  text-align:center;
}

th{
  background:#a5d6a7;
}

.humedo{
  background:#ffebee;
  color:#c62828;
  font-weight:bold;
}

/* ===== MODAL (FIX REAL) ===== */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;        /* üîë */
  justify-content:center;    /* üîë */
  z-index:9999;
}

.modal-content{
  background:white;
  width:90%;
  max-width:520px;
  max-height:85vh;           /* üîë */
  overflow-y:auto;           /* üîë */
  padding:20px;
  border-radius:14px;
}

.modal-content label{
  display:block;
  margin-top:10px;
  font-weight:bold;
}

.modal-content input{
  width:100%;
  padding:6px;
  margin-top:4px;
}

.modal-actions{
  margin-top:15px;
  display:flex;
  gap:10px;
}
</style>
</head>

<body>

<header>PANEL DE CONTROL ¬∑ SILO BOLSAS</header>

<div class="container">

  <div class="toolbar">
    <button onclick="location.href='/form'">‚ûï Nuevo registro</button>
    <button onclick="location.href='/api/export'">üì§ Exportar Excel</button>
    <button onclick="centrarUsuario()">üìç Mi ubicaci√≥n</button>
    <button onclick="document.getElementById('map').requestFullscreen()">üñ•Ô∏è Pantalla completa</button>
  </div>

  <div id="map"></div>

  <table>
    <thead>
      <tr>
        <th>QR</th>
        <th>Cereal</th>
        <th>Estado</th>
        <th>Fecha confecci√≥n</th>
        <th>Grado</th>
        <th>Factor</th>
      </tr>
    </thead>
    <tbody>
    {% for r in registros %}
      <tr onclick="abrir('{{r.numero_qr}}','{{r.cereal}}')">
        <td>{{r.numero_qr}}</td>
        <td>{{r.cereal}}</td>
        <td class="{{ 'humedo' if r.estado=='Humedo' else '' }}">{{r.estado}}</td>
        <td>{{r.fecha_confeccion}}</td>
        <td>{{r.grado or '-'}}</td>
        <td>{{r.factor or '-'}}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>

</div>

<!-- ===== MODAL ANALISIS ===== -->
<div id="modal" class="modal">
  <div class="modal-content">
    <h3 id="titulo"></h3>

    <form id="formAnalisis">
      <input type="hidden" id="qr">

      <label>Humedad (%)</label>
      <input id="humedad">

      <label>Peso hectol√≠trico</label>
      <input id="ph">

      <label>Granos da√±ados (%)</label>
      <input id="danados">

      <label>Quebrados (%)</label>
      <input id="quebrados">

      <label>Materia extra√±a (%)</label>
      <input id="me">

      <div class="modal-actions">
        <button type="submit">üíæ Guardar an√°lisis</button>
        <button type="button" onclick="cerrar()">Cancelar</button>
      </div>
    </form>

    <div id="resultado" style="margin-top:10px;font-weight:bold"></div>
  </div>
</div>

<script>
/* MAPA */
const map=L.map('map');
L.tileLayer(
 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
 {attribution:'¬© Esri'}
).addTo(map);
map.setView([-34.6,-58.4],6);

function centrarUsuario(){
  navigator.geolocation.getCurrentPosition(p=>{
    map.setView([p.coords.latitude,p.coords.longitude],16);
  });
}

/* MODAL */
let cerealActual="";

function abrir(qr,cereal){
  cerealActual=cereal;
  document.getElementById("qr").value=qr;
  document.getElementById("titulo").innerText=`An√°lisis comercial ¬∑ ${cereal} ¬∑ ${qr}`;
  document.getElementById("modal").style.display="flex";  // üîë
}

function cerrar(){
  document.getElementById("modal").style.display="none";
  resultado.innerHTML="";
}

document.getElementById("formAnalisis").onsubmit=async e=>{
  e.preventDefault();
  const data={
    numero_qr:qr.value,
    cereal:cerealActual,
    datos:{
      humedad:humedad.value,
      ph:ph.value,
      danados:danados.value,
      quebrados:quebrados.value,
      me:me.value
    }
  };
  const r=await fetch("/api/analisis",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(data)
  });
  const j=await r.json();
  resultado.innerText=`Grado: ${j.grado} | Factor: ${j.factor}`;
  setTimeout(()=>location.reload(),900);
};
</script>

</body>
</html>
