<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Silo Bolsa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  background:#e6f4ea;
  font-family:Arial, sans-serif;
  padding:20px;
  color:#1e4620;
}
h2{text-align:center}
label{display:block;margin-top:14px;font-weight:bold}
input,select,button{
  width:100%;
  padding:12px;
  margin-top:6px;
  border-radius:10px;
  border:1px solid #4caf50;
  font-size:15px;
}
input[readonly]{background:#f0f0f0}
button{
  background:#4caf50;
  color:white;
  border:none;
  margin-top:16px;
  font-size:16px;
  font-weight:bold;
}
button:disabled{background:#9ccc9c}
.hidden{display:none}
.card{
  background:#ffffff;
  border-radius:12px;
  padding:12px;
  margin-top:14px;
}
.alert{
  background:#fff3cd;
  padding:10px;
  border-radius:8px;
  margin-top:10px;
}
</style>
</head>

<body>

<h2>Silo Bolsa</h2>

<label>QR</label>
<input id="qr" readonly>

<div id="infoSilo" class="alert hidden"></div>

<!-- REGISTRO -->
<div id="bloqueRegistro" class="hidden card">
  <label>Cereal</label>
  <select id="cereal">
    <option value="">Seleccioneâ€¦</option>
    <option>MaÃ­z</option>
    <option>Soja</option>
    <option>Trigo</option>
    <option>Girasol</option>
  </select>

  <label>Estado grano</label>
  <select id="estado_grano">
    <option value="">Seleccioneâ€¦</option>
    <option>Seco</option>
    <option>Humedo</option>
  </select>

  <label>Metros lineales</label>
  <input type="number" id="metros">
</div>

<!-- NUEVO EVENTO -->
<div id="bloqueEvento" class="hidden card">
  <h3>âž• Nuevo evento</h3>

  <label>Tipo de evento</label>
  <select id="tipo_evento">
    <option value="">Seleccioneâ€¦</option>
    <option>Rotura</option>
    <option>Malezas</option>
    <option>Encharcado</option>
    <option>Animales</option>
    <option>Otros</option>
  </select>

  <input id="detalle_evento" class="hidden" placeholder="Detalle">

  <label>Foto del problema</label>
  <input type="file" id="foto_evento" accept="image/*" capture="environment">
</div>

<!-- EVENTOS PENDIENTES -->
<div id="bloquePendientes" class="hidden card">
  <h3>ðŸ”§ Eventos pendientes</h3>
  <div id="listaPendientes"></div>
</div>

<button id="btnGuardar" onclick="guardar()">Guardar</button>

<script>
const params = new URLSearchParams(location.search);
const qr = params.get("id");
document.getElementById("qr").value = qr || "";

let modo = null;
let eventosPendientes = [];

/* ===== INIT ===== */
async function init(){
  if(!qr) return;

  const r = await fetch(`/api/silo/${qr}`);
  const d = await r.json();

  if(!d.existe){
    modo="registro";
    bloqueRegistro.classList.remove("hidden");
  }else{
    modo="monitoreo";
    infoSilo.innerHTML = `ðŸŒ½ <b>${d.cereal}</b> | ðŸ“… ${d.fecha_confeccion}`;
    infoSilo.classList.remove("hidden");
    bloqueEvento.classList.remove("hidden");
    bloquePendientes.classList.remove("hidden");
    cargarPendientes();
  }
}

/* ===== OTROS ===== */
tipo_evento.onchange = e=>{
  detalle_evento.classList.toggle("hidden", e.target.value!=="Otros");
};

/* ===== CARGAR PENDIENTES ===== */
async function cargarPendientes(){
  const r = await fetch(`/silo/${qr}`);
  const html = await r.text();
  const div = document.createElement("div");
  div.innerHTML = html;

  const rows = div.querySelectorAll("[data-pendiente]");
  listaPendientes.innerHTML = "";

  rows.forEach(r=>{
    const id = r.dataset.id;
    listaPendientes.innerHTML += `
      <div class="card">
        <b>${r.dataset.tipo}</b><br>
        ðŸ“… ${r.dataset.fecha}<br>
        <label>
          Foto reparaciÃ³n
          <input type="file" onchange="resolver(${id}, this.files[0])">
        </label>
      </div>
    `;
  });
}

/* ===== GUARDAR ===== */
async function guardar(){
  btnGuardar.disabled=true;

  if(modo==="registro"){
    await fetch("/api/registrar_silo",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        numero_qr:qr,
        cereal:cereal.value,
        estado_grano:estado_grano.value,
        metros:metros.value
      })
    });
    location.reload();
    return;
  }

  if(tipo_evento.value){
    const fd = new FormData();
    fd.append("numero_qr", qr);
    fd.append("tipo", tipo_evento.value);
    fd.append("detalle", detalle_evento.value);
    if(foto_evento.files[0]) fd.append("foto", foto_evento.files[0]);

    await fetch("/api/monitoreo",{method:"POST",body:fd});
    location.reload();
    return;
  }

  alert("No hay datos para guardar");
  btnGuardar.disabled=false;
}

/* ===== RESOLVER ===== */
async function resolver(id, foto){
  const fd = new FormData();
  fd.append("id", id);
  fd.append("foto_solucion", foto);

  await fetch("/api/monitoreo_resolver",{method:"POST",body:fd});
  location.reload();
}

init();
</script>

</body>
</html>
