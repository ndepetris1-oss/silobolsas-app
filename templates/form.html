<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Silo Bolsa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  background:#e6f4ea;
  font-family:Arial, sans-serif;
  padding:20px;
  color:#1e4620;
}
h2{
  text-align:center;
}
label{
  display:block;
  margin-top:14px;
  font-weight:bold;
}
input, select, button{
  width:100%;
  padding:12px;
  margin-top:6px;
  border-radius:10px;
  border:1px solid #4caf50;
  font-size:15px;
}
input[readonly]{
  background:#f0f0f0;
}
button{
  background:#4caf50;
  color:white;
  border:none;
  margin-top:22px;
  font-size:16px;
  font-weight:bold;
}
.hidden{display:none}
.alert{
  margin-top:15px;
  padding:12px;
  border-radius:10px;
  background:#fff3cd;
  color:#856404;
  font-weight:bold;
  text-align:center;
}
</style>
</head>

<body>

<h2>Silo Bolsa</h2>

<label>Número de QR</label>
<input type="text" id="qr" readonly>

<div id="bloqueRegistro" class="hidden">

  <label>Cereal</label>
  <select id="cereal">
    <option value="">Seleccione…</option>
    <option>Maíz</option>
    <option>Soja</option>
    <option>Trigo</option>
    <option>Girasol</option>
  </select>

  <label>Estado del grano</label>
  <select id="estado_grano">
    <option value="">Seleccione…</option>
    <option value="Seco">Seco</option>
    <option value="Humedo">Húmedo</option>
  </select>

  <label>Metros lineales</label>
  <input type="number" id="metros" placeholder="Ej: 60">

</div>

<div id="bloqueExtraccion" class="hidden">

  <div class="alert">
    ⚠️ Este silo ya fue registrado.<br>
    Informar extracción.
  </div>

  <label>Tipo de extracción</label>
  <select id="estado_silo">
    <option value="">Seleccione…</option>
    <option value="Extracción parcial">Extracción parcial</option>
    <option value="Extraído">Extraído (completo)</option>
  </select>

</div>

<button onclick="guardar()">Guardar</button>

<script>
const params = new URLSearchParams(window.location.search);
const qr = params.get("id");
document.getElementById("qr").value = qr || "";

let modo = null; // registro | extraccion

async function init(){
  if(!qr) return;

  const res = await fetch(`/api/silo/${qr}`);
  const data = await res.json();

  if(data.existe){
    modo = "extraccion";
    document.getElementById("bloqueExtraccion").classList.remove("hidden");
  }else{
    modo = "registro";
    document.getElementById("bloqueRegistro").classList.remove("hidden");
  }
}

async function guardar(){
  if(!qr){
    alert("QR inválido");
    return;
  }

  let lat=null, lon=null;
  try{
    const pos = await new Promise((ok,err)=>
      navigator.geolocation.getCurrentPosition(ok,err,{timeout:5000})
    );
    lat = pos.coords.latitude;
    lon = pos.coords.longitude;
  }catch(e){}

  if(modo==="registro"){
    const cereal = document.getElementById("cereal").value;
    const estado_grano = document.getElementById("estado_grano").value;
    const metros = document.getElementById("metros").value;

    if(!cereal || !estado_grano || !metros){
      alert("Complete todos los campos");
      return;
    }

    await fetch("/api/registrar_silo",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        numero_qr:qr,
        cereal,
        estado_grano,
        metros,
        lat,
        lon
      })
    });

    alert("Silo registrado correctamente");
    window.location.reload();
  }

  if(modo==="extraccion"){
    const estado_silo = document.getElementById("estado_silo").value;
    if(!estado_silo){
      alert("Seleccione tipo de extracción");
      return;
    }

    await fetch("/api/extraccion",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        numero_qr:qr,
        estado_silo
      })
    });

    alert("Extracción registrada correctamente");
    window.location.reload();
  }
}

init();
</script>

</body>
</html>
