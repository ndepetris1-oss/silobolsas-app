<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro de Silo Bolsa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  background-color:#e6f4ea;
  font-family:Arial,sans-serif;
  padding:20px;
  color:#2d5a27;
}
h2{
  text-align:center;
  color:#1e4620;
}
label{
  display:block;
  margin-top:12px;
  font-weight:bold;
}
input,select,button{
  width:100%;
  padding:10px;
  margin-top:6px;
  border-radius:8px;
  border:1px solid #5cb85c;
  box-sizing:border-box;
  font-size:15px;
}
input[readonly]{
  background:#f0f0f0;
}
button{
  background-color:#5cb85c;
  color:white;
  border:none;
  margin-top:20px;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;
}
button:hover{
  background-color:#4cae4c;
}
</style>
</head>

<body>

<h2>Registro de Silo Bolsa</h2>

<label>Número de QR</label>
<input type="text" id="numero_qr" readonly>

<label>Cereal</label>
<select id="cereal">
  <option value="">Seleccione…</option>
  <option value="Maíz">Maíz</option>
  <option value="Trigo">Trigo</option>
  <option value="Soja">Soja</option>
  <option value="Girasol">Girasol</option>
</select>

<label>Estado del grano</label>
<select id="estado">
  <option value="">Seleccione…</option>
  <option value="Seco">Seco</option>
  <option value="Humedo">Húmedo</option>
</select>

<label>Metros lineales</label>
<input type="number" id="metros" placeholder="Ej: 75">

<!-- FECHA LOCAL -->
<input type="hidden" id="fecha_confeccion">

<button onclick="enviar()">Registrar</button>

<script>
// Obtener QR desde la URL
const params = new URLSearchParams(window.location.search);
const qrInput = document.getElementById("numero_qr");
qrInput.value = params.get("id") || "";

// Fecha y hora LOCAL real (Argentina)
const now = new Date();
const localISO = new Date(
  now.getTime() - now.getTimezoneOffset() * 60000
).toISOString().slice(0,19);
document.getElementById("fecha_confeccion").value = localISO;

async function enviar(){
  if(!qrInput.value){
    alert("QR no válido");
    return;
  }

  const cereal = document.getElementById("cereal").value;
  const estado = document.getElementById("estado").value;
  const metros = document.getElementById("metros").value;

  if(!cereal || !estado || !metros){
    alert("Complete todos los campos");
    return;
  }

  try{
    const pos = await new Promise((ok,err)=>
      navigator.geolocation.getCurrentPosition(ok,err)
    );

    const data = {
      numero_qr: qrInput.value,
      cereal: cereal,
      estado: estado,
      metros: metros,
      lat: pos.coords.latitude,
      lon: pos.coords.longitude,
      fecha_confeccion: document.getElementById("fecha_confeccion").value
    };

    const res = await fetch("/api/save",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(data)
    });

    const r = await res.json();
    if(r.status === "ok"){
      alert("Registro guardado correctamente");
    }else{
      alert("Error al guardar");
    }
  }catch(e){
    alert("Error de geolocalización o conexión");
  }
}
</script>

</body>
</html>
