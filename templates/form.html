<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Silo Bolsa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{background:#e6f4ea;font-family:Arial;padding:20px;color:#1e4620}
h2{text-align:center}
label{display:block;margin-top:14px;font-weight:bold}
input,select,button{
  width:100%;padding:12px;margin-top:6px;
  border-radius:10px;border:1px solid #4caf50;font-size:15px
}
button{
  background:#4caf50;color:white;border:none;
  margin-top:22px;font-size:16px;font-weight:bold
}
.hidden{display:none}
.alert{
  margin-top:15px;padding:12px;border-radius:10px;
  background:#fff3cd;color:#856404;font-weight:bold;text-align:center
}
</style>
</head>

<body>

<h2>Silo Bolsa</h2>

<label>N√∫mero de QR</label>
<input type="text" id="qr" readonly>

<div id="infoSilo" class="alert hidden"></div>

<!-- REGISTRO -->
<div id="bloqueRegistro" class="hidden">
  <label>Cereal</label>
  <select id="cereal">
    <option value="">Seleccione‚Ä¶</option>
    <option>Ma√≠z</option>
    <option>Soja</option>
    <option>Trigo</option>
    <option>Girasol</option>
  </select>

  <label>Estado del grano</label>
  <select id="estado_grano">
    <option value="">Seleccione‚Ä¶</option>
    <option>Seco</option>
    <option>Humedo</option>
  </select>

  <label>Metros lineales</label>
  <input type="number" id="metros">
</div>

<!-- EXTRACCION -->
<div id="bloqueExtraccion" class="hidden">
  <label>Tipo de extracci√≥n</label>
  <select id="estado_silo">
    <option value="">Seleccione‚Ä¶</option>
    <option>Extracci√≥n parcial</option>
    <option>Extra√≠do</option>
  </select>
</div>

<!-- MONITOREO -->
<div id="bloqueMonitoreo" class="hidden">
  <hr>
  <h3>Monitoreo en campo</h3>

  <label>Tipo de evento</label>
  <select id="tipo_evento">
    <option value="">Seleccione‚Ä¶</option>
    <option>Rotura</option>
    <option>Malezas</option>
    <option>Encharcado</option>
    <option>Animales</option>
    <option>Otros</option>
  </select>

  <input id="detalle_evento" class="hidden" placeholder="Detalle (otros)">

  <label>Foto</label>
  <input 
  type="file"
  id="foto"
  accept="image/*"
  capture="environment"
>
</div>

<button onclick="guardar()">Guardar</button>

<script>
const params=new URLSearchParams(window.location.search);
const qr=params.get("id");
qr && (document.getElementById("qr").value=qr);

let modo=null;

async function init(){
  if(!qr) return;

  const res=await fetch(`/api/silo/${qr}`);
  const data=await res.json();

  if(data.existe){
    modo="extraccion";
    bloqueExtraccion.classList.remove("hidden");
    bloqueMonitoreo.classList.remove("hidden");

    infoSilo.innerHTML=`üåΩ <b>${data.cereal}</b> | üìÖ ${data.fecha_confeccion}`;
    infoSilo.classList.remove("hidden");
  }else{
    modo="registro";
    bloqueRegistro.classList.remove("hidden");
  }
}

tipo_evento.onchange=e=>{
  detalle_evento.classList.toggle("hidden",e.target.value!=="Otros");
};

async function guardar(){
  if(modo==="registro"){
    await fetch("/api/registrar_silo",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        numero_qr:qr,
        cereal:cereal.value,
        estado_grano:estado_grano.value,
        metros:metros.value
      })
    });
    alert("Silo registrado");
    location.reload();
    return;
  }

  if(tipo_evento.value){
    const fd=new FormData();
    fd.append("numero_qr",qr);
    fd.append("tipo",tipo_evento.value);
    fd.append("detalle",detalle_evento.value);
    if(foto.files[0]) fd.append("foto",foto.files[0]);

    await fetch("/api/monitoreo",{method:"POST",body:fd});
    alert("Monitoreo guardado");
    location.reload();
    return;
  }

  if(estado_silo.value){
    await fetch("/api/extraccion",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        numero_qr:qr,
        estado_silo:estado_silo.value
      })
    });
    alert("Extracci√≥n registrada");
    location.reload();
  }
}

init();
</script>

</body>
</html>
