<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Silo Bolsa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  background:#e6f4ea;
  font-family:Arial,sans-serif;
  padding:20px;
  color:#2d5a27
}
h2{text-align:center;color:#1e4620}
label{display:block;margin-top:12px;font-weight:bold}
input,select,button{
  width:100%;padding:10px;margin-top:6px;
  border-radius:8px;border:1px solid #5cb85c;
  font-size:15px
}
input[readonly]{background:#f0f0f0}
button{
  background:#5cb85c;color:white;
  border:none;margin-top:20px;
  font-size:16px;font-weight:bold;cursor:pointer
}
button:hover{background:#4cae4c}
.box{
  background:#dcedc8;
  padding:12px;
  border-radius:10px;
  margin-bottom:15px;
  font-weight:bold;
}
.hidden{display:none}
</style>
</head>

<body>

<h2>Silo Bolsa</h2>

<label>N√∫mero de QR</label>
<input type="text" id="numero_qr" readonly>

<div id="aviso" class="box hidden"></div>

<!-- REGISTRO -->
<div id="bloqueRegistro" class="hidden">

  <label>Cereal</label>
  <select id="cereal">
    <option value="">Seleccione‚Ä¶</option>
    <option>Ma√≠z</option>
    <option>Trigo</option>
    <option>Soja</option>
    <option>Girasol</option>
  </select>

  <label>Estado del grano</label>
  <select id="estado">
    <option value="">Seleccione‚Ä¶</option>
    <option value="Seco">Seco</option>
    <option value="Humedo">H√∫medo</option>
  </select>

  <label>Metros lineales</label>
  <input type="number" id="metros" placeholder="Ej: 75">

</div>

<!-- EXTRACCION -->
<div id="bloqueExtraccion" class="hidden">

  <label>Tipo de extracci√≥n</label>
  <select id="estado_silo">
    <option value="">Seleccione‚Ä¶</option>
    <option value="Extracci√≥n parcial">Extracci√≥n parcial</option>
    <option value="Extra√≠do">Extra√≠do</option>
  </select>

</div>

<button onclick="enviar()">Guardar</button>

<script>
const params = new URLSearchParams(window.location.search);
const qr = params.get("id");
numero_qr.value = qr || "";

async function init(){
  if(!qr){
    alert("QR inv√°lido");
    return;
  }

  const res = await fetch(`/api/silo/${qr}`);
  const data = await res.json();

  if(data.existe){
    aviso.innerText = "‚ö†Ô∏è Silo ya registrado. Registrar extracci√≥n.";
    aviso.classList.remove("hidden");
    bloqueExtraccion.classList.remove("hidden");
  }else{
    aviso.innerText = "üÜï Registrar nuevo silo bolsa.";
    aviso.classList.remove("hidden");
    bloqueRegistro.classList.remove("hidden");
  }
}

async function enviar(){

  let payload = { numero_qr: qr };

  if(!bloqueRegistro.classList.contains("hidden")){
    if(!cereal.value || !estado.value || !metros.value){
      alert("Complete todos los datos del silo");
      return;
    }

    let lat=null, lon=null;
    try{
      const pos = await new Promise((ok,err)=>
        navigator.geolocation.getCurrentPosition(ok,err,{timeout:5000})
      );
      lat = pos.coords.latitude;
      lon = pos.coords.longitude;
    }catch(e){}

    payload = {
      ...payload,
      cereal: cereal.value,
      estado: estado.value,
      metros: metros.value,
      lat, lon
    };
  }

  if(!bloqueExtraccion.classList.contains("hidden")){
    if(!estado_silo.value){
      alert("Seleccione el tipo de extracci√≥n");
      return;
    }
    payload.estado_silo = estado_silo.value;
  }

  const r = await fetch("/api/save",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });

  const j = await r.json();
  if(j.ok){
    alert("Datos guardados correctamente");
  }else{
    alert("Error al guardar");
  }
}

init();
</script>

</body>
</html>
