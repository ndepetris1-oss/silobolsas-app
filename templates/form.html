<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Silo Bolsa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  background:#e6f4ea;
  font-family:Arial, sans-serif;
  padding:20px;
  color:#1e4620;
}
h2{text-align:center}
label{display:block;margin-top:14px;font-weight:bold}
input,select,button{
  width:100%;
  padding:12px;
  margin-top:6px;
  border-radius:10px;
  border:1px solid #4caf50;
  font-size:15px;
}
input[readonly]{background:#f0f0f0}
button{
  background:#4caf50;
  color:white;
  border:none;
  margin-top:18px;
  font-size:16px;
  font-weight:bold;
}
button:disabled{background:#9ccc9c}
.hidden{display:none}
.card{
  background:#ffffff;
  border-radius:12px;
  padding:14px;
  margin-top:14px;
}
.alert{
  background:#fff3cd;
  padding:10px;
  border-radius:8px;
  margin-top:10px;
  font-weight:bold;
}
  .switch {
  position: relative;
  display: inline-block;
  width: 56px;
  height: 32px;
  margin-right: 10px;
  vertical-align: middle;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: #ccc;
  transition: .3s;
  border-radius: 34px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 24px;
  width: 24px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .3s;
  border-radius: 50%;
}

.switch input:checked + .slider {
  background-color: #4caf50;
}

.switch input:checked + .slider:before {
  transform: translateX(24px);
}

.switch-label {
  font-weight: bold;
  vertical-align: middle;
}
</style>
</head>

<body>

<h2>Silo Bolsa</h2>

<label>QR</label>
<input id="qr" readonly>

<div id="infoSilo" class="alert hidden"></div>

<!-- REGISTRO -->
<div id="bloqueRegistro" class="card hidden">
  <h3>üÜï Registro de silo</h3>

  <label>Cereal</label>
  <select id="cereal">
    <option value="">Seleccione‚Ä¶</option>
    <option>Ma√≠z</option>
    <option>Soja</option>
    <option>Trigo</option>
    <option>Girasol</option>
  </select>

  <label>Estado del grano</label>
  <select id="estado_grano">
    <option value="">Seleccione‚Ä¶</option>
    <option>Seco</option>
    <option>Humedo</option>
  </select>

  <label>Metros lineales</label>
  <input type="number" id="metros">
</div>

<!-- MONITOREO -->
<div id="bloqueMonitoreo" class="card hidden">
  <h3>üì∏ Monitoreo en campo</h3>

  <label>Tipo de evento</label>
  <select id="tipo_evento">
    <option value="">Seleccione‚Ä¶</option>
    <option>Rotura</option>
    <option>Malezas</option>
    <option>Encharcado</option>
    <option>Animales</option>
    <option>Otros</option>
  </select>

  <input
    id="detalle_evento"
    class="hidden"
    placeholder="Detalle (solo si es Otros)"
  >

  <label>Foto del evento</label>
  <input
    type="file"
    id="foto"
    accept="image/*"
    capture="environment"
  >
</div>

  <!-- RESOLUCI√ìN DE EVENTO -->
<div id="bloqueResolucion" class="card hidden">
  <h3>‚úÖ Resolver evento</h3>

  <label class="switch">
  <input type="checkbox" id="resuelto">
  <span class="slider"></span>
</label>
<span class="switch-label">Marcar evento como resuelto</span>
  </label>

  <label>Foto de resoluci√≥n</label>
  <input
    type="file"
    id="foto_resolucion"
    accept="image/*"
    capture="environment"
  >
</div>
  
<!-- EXTRACCION -->
<div id="bloqueExtraccion" class="card hidden">
  <h3>üì¶ Extracci√≥n</h3>

  <label>Tipo de extracci√≥n</label>
  <select id="estado_silo">
    <option value="">Seleccione‚Ä¶</option>
    <option>Extracci√≥n parcial</option>
    <option>Extra√≠do</option>
  </select>
</div>

<button id="btnGuardar" onclick="guardar()">Guardar</button>

<script>
const params = new URLSearchParams(window.location.search);
const qr = params.get("id");
document.getElementById("qr").value = qr || "";

let modo = null;
let lat = null;
let lon = null;
let eventoPendiente = null;

/* ===== GPS ===== */
async function obtenerGPS(){
  try{
    const pos = await new Promise((ok, err) =>
      navigator.geolocation.getCurrentPosition(ok, err, {
        enableHighAccuracy: true,
        timeout: 8000
      })
    );
    lat = pos.coords.latitude;
    lon = pos.coords.longitude;
  }catch(e){
    console.warn("GPS no disponible");
  }
}

/* ===== INIT ===== */
async function init(){
  if(!qr) return;

  await obtenerGPS();

  const res = await fetch(`/api/silo/${qr}`);
  const data = await res.json();

  /* ===== REGISTRO ===== */
  if(!data.existe){
    modo = "registro";
    bloqueRegistro.classList.remove("hidden");
    return;
  }

  /* ===== OPERACI√ìN ===== */
  modo = "operacion";

  infoSilo.innerHTML = `
    üåΩ <b>${data.cereal}</b> &nbsp;|&nbsp;
    üìÖ <b>${data.fecha_confeccion}</b>
  `;
  infoSilo.classList.remove("hidden");

  // estado base
  bloqueMonitoreo.classList.remove("hidden");
  bloqueExtraccion.classList.remove("hidden");
  bloqueResolucion.classList.add("hidden");

  /* ===== EVENTO PENDIENTE ===== */
  const resMon = await fetch(`/api/monitoreo/pendiente/${qr}`);
  const mon = await resMon.json();

  console.log("MONITOREO PENDIENTE:", mon);

  if(mon.pendiente){
    eventoPendiente = mon;

    bloqueMonitoreo.classList.add("hidden");
    bloqueResolucion.classList.remove("hidden");

    infoSilo.innerHTML += `
      <br>‚ö†Ô∏è Evento pendiente: <b>${mon.tipo}</b>
    `;
  }
} // üî¥ ESTE CIERRE FALTABA

/* ===== OTROS ===== */
tipo_evento.onchange = e=>{
  detalle_evento.classList.toggle(
    "hidden",
    e.target.value !== "Otros"
  );
};

/* ===== GUARDAR ===== */
async function guardar(){
  const btn = document.getElementById("btnGuardar");
  btn.disabled = true;
  btn.innerText = "Guardando‚Ä¶";

  /* REGISTRO */
  if(modo === "registro"){
    if(!cereal.value || !estado_grano.value || !metros.value){
      alert("Complete todos los campos");
      btn.disabled=false;
      btn.innerText="Guardar";
      return;
    }

    await fetch("/api/registrar_silo",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        numero_qr: qr,
        cereal: cereal.value,
        estado_grano: estado_grano.value,
        metros: metros.value,
        lat: typeof lat === "number" ? lat : null,
        lon: typeof lon === "number" ? lon : null
      })
    });

    alert("Silo registrado correctamente");
    location.reload();
    return;
  }

  /* NUEVO EVENTO */
  if(tipo_evento.value && !eventoPendiente){
    const fd = new FormData();
    fd.append("numero_qr", qr);
    fd.append("tipo", tipo_evento.value);
    fd.append("detalle", detalle_evento.value);
    if(foto.files[0]) fd.append("foto", foto.files[0]);

    await fetch("/api/monitoreo",{ method:"POST", body:fd });

    alert("Evento registrado");
    location.reload();
    return;
  }

  /* RESOLVER EVENTO */
  if(eventoPendiente && resuelto.checked){
    const fd = new FormData();
    fd.append("id_monitoreo", eventoPendiente.id);
    if(foto_resolucion.files[0]){
      fd.append("foto", foto_resolucion.files[0]);
    }

    await fetch("/api/monitoreo/resolver",{ method:"POST", body:fd });

    alert("Evento resuelto correctamente");
    location.reload();
    return;
  }

  /* EXTRACCI√ìN */
  if(estado_silo.value){
    await fetch("/api/extraccion",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        numero_qr: qr,
        estado_silo: estado_silo.value
      })
    });

    alert("Extracci√≥n registrada");
    location.reload();
    return;
  }

  alert("No hay datos para guardar");
  btn.disabled=false;
  btn.innerText="Guardar";
}

/* ===== START ===== */
init();
</script>
