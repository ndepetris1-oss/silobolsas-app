<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro / Extracción Silo Bolsa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  background:#e6f4ea;
  font-family:Arial, sans-serif;
  padding:20px;
  color:#1e4620;
}
h2{text-align:center}
label{display:block;margin-top:12px;font-weight:bold}
input,select,button{
  width:100%;padding:10px;margin-top:6px;
  border-radius:8px;border:1px solid #66bb6a;
  font-size:15px;
}
button{
  background:#43a047;color:white;border:none;
  margin-top:20px;font-size:16px;font-weight:bold;
}
button:hover{background:#2e7d32}
.hidden{display:none}
.box{
  background:white;padding:15px;border-radius:12px;
  margin-top:15px;
}
</style>
</head>

<body>

<h2 id="titulo">Registro de Silo Bolsa</h2>

<div class="box">

<label>QR</label>
<input type="text" id="numero_qr" readonly>

<!-- ================= CONFECCIÓN ================= -->
<div id="confeccion">

<label>Cereal</label>
<select id="cereal">
  <option value="">Seleccione…</option>
  <option>Maíz</option>
  <option>Trigo</option>
  <option>Soja</option>
  <option>Girasol</option>
</select>

<label>Estado del grano</label>
<select id="estado">
  <option value="">Seleccione…</option>
  <option>Seco</option>
  <option>Humedo</option>
</select>

<label>Metros lineales</label>
<input type="number" id="metros" placeholder="Ej: 75">

</div>

<!-- ================= EXTRACCIÓN ================= -->
<div id="extraccion" class="hidden">

<label>Tipo de extracción</label>
<select id="tipo_extraccion">
  <option value="">Seleccione…</option>
  <option value="parcial">Parcial</option>
  <option value="completa">Completa</option>
</select>

</div>

<button onclick="guardar()">Guardar</button>

</div>

<script>
const params = new URLSearchParams(window.location.search);
const qr = params.get("id");
document.getElementById("numero_qr").value = qr || "";

const confeccionBox = document.getElementById("confeccion");
const extraccionBox = document.getElementById("extraccion");
const titulo = document.getElementById("titulo");

let modo = "confeccion";

// ================= DETECTAR QR =================
async function detectarQR(){
  if(!qr) return;

  const res = await fetch(`/api/silo/${qr}`);
  const data = await res.json();

  if(data.numero_qr){
    // Ya existe → EXTRACCIÓN
    modo = "extraccion";
    titulo.innerText = "Extracción de Silo Bolsa";
    confeccionBox.classList.add("hidden");
    extraccionBox.classList.remove("hidden");
  }
}

detectarQR();

// ================= GUARDAR =================
async function guardar(){
  if(!qr){
    alert("QR no válido");
    return;
  }

  let payload = { numero_qr: qr };

  if(modo === "confeccion"){
    payload.cereal = cereal.value;
    payload.estado = estado.value;
    payload.metros = metros.value;

    if(!payload.cereal || !payload.estado || !payload.metros){
      alert("Complete todos los campos");
      return;
    }

    // GPS
    try{
      const pos = await new Promise((ok,err)=>
        navigator.geolocation.getCurrentPosition(ok,err,{timeout:5000})
      );
      payload.lat = pos.coords.latitude;
      payload.lon = pos.coords.longitude;
    }catch(e){}

    await fetch("/api/save",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify(payload)
    });

    alert("Confección registrada correctamente");
    location.reload();
  }

  if(modo === "extraccion"){
    const tipo = document.getElementById("tipo_extraccion").value;
    if(!tipo){
      alert("Seleccione tipo de extracción");
      return;
    }

    await fetch("/api/extraccion",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        numero_qr: qr,
        tipo_extraccion: tipo
      })
    });

    alert("Extracción registrada correctamente");
    location.reload();
  }
}
</script>

</body>
</html>
