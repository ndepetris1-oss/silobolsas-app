<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Comparador comercial â€“ {{ cereal }}</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:Arial, sans-serif;
  background:#eef5f1;
  margin:0;
}
header{
  background:#2e7d32;
  color:white;
  padding:14px;
  text-align:center;
  font-size:20px;
}
.container{
  width:95%;
  margin:15px auto;
  background:white;
  border-radius:14px;
  padding:15px;
}
select, button, input{
  width:100%;
  padding:10px;
  margin-top:8px;
  border-radius:8px;
  border:1px solid #81c784;
  font-size:15px;
}
button{
  background:#43a047;
  color:white;
  font-weight:bold;
  cursor:pointer;
}
button:hover{background:#2e7d32}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
th,td{
  padding:8px;
  border-bottom:1px solid #c8e6c9;
  text-align:center;
}
th{background:#a5d6a7}
.card{
  background:#f1f8f4;
  padding:12px;
  border-radius:10px;
  margin-top:12px;
}
.bad{color:#b71c1c;font-weight:bold}
.good{color:#2e7d32;font-weight:bold}
</style>
</head>

<body>

<header>ğŸ’° Comparador comercial â€“ {{ cereal }}</header>

<div class="container">

<button onclick="location.href='/comercial'">â† Volver</button>

<div class="card">
  <h3>ğŸŒ¾ Seleccionar silo</h3>
  <select id="siloSelect">
    <option value="">Seleccione un siloâ€¦</option>
    {% for s in silos %}
      <option value="{{ s.numero_qr }}">
        {{ s.numero_qr }} â€” Factor prom: {{ s.factor_prom or "-" }}
      </option>
    {% endfor %}
  </select>
</div>

<div class="card">
  <h3>ğŸ¢ Oferentes</h3>
  <button onclick="abrirGastos(this)">
  âš™ï¸ Gastos
</button>

  <table>
    <tr>
      <th>Oferente</th>
      <th>Precio pizarra</th>
      <th>Gastos</th>
      <th>Precio neto</th>
      <th>Dif. vs mejor</th>
    </tr>

    {% for i in range(4) %}
<tr>
  <td>
    <input placeholder="Ej: ACA, Cargill">
  </td>

  <td>
    <input type="number" placeholder="ARS/TN">
  </td>

  <td>
  <div class="small total-gastos">0 ARS/TN</div>
  </td>

  <td class="precio-neto">-</td>
  <td class="dif-mejor">-</td>
</tr>
{% endfor %}
  </table>

  <button style="margin-top:12px" disabled>
    ğŸ§® Calcular comparaciÃ³n
  </button>
</div>

</div>
<!-- MODAL GASTOS -->
<div id="modalGastos" style="
  display:none;
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.5);
  z-index:999">

  <div style="
    background:white;
    width:90%;
    max-width:520px;
    margin:50px auto;
    padding:20px;
    border-radius:14px">

    <h3>âš™ï¸ Gastos del oferente (USD/TN)</h3>

    <label>ğŸšš Flete</label>
    <input type="number" step="0.01" id="g_flete">

    <label>â†©ï¸ Contra flete</label>
    <input type="number" step="0.01" id="g_contra">

    <label>ğŸ¤ Paritarias</label>
    <input type="number" step="0.01" id="g_paritarias">

    <label>ğŸ”¥ Secada (USD/TN por punto)</label>
    <input type="number" step="0.01" id="g_secada">

    <label>ğŸ§ª Fumigada</label>
    <input type="number" step="0.01" id="g_fumigada">

    <label>ğŸŒ€ Zarandeo</label>
    <input type="number" step="0.01" id="g_zarandeo">

    <label>ğŸ¢ Almacenaje</label>
    <input type="number" step="0.01" id="g_almacenaje">

    <label>ğŸ“¦ Manipuleo / descarga</label>
    <input type="number" step="0.01" id="g_manipuleo">

    <hr>

    <label>ğŸ BonificaciÃ³n secada (puntos %)</label>
    <input type="number" step="0.1" id="bonif_secada" placeholder="Ej: 2 â†’ cobra desde base + 2">

    <label>
      <input type="checkbox" id="bonif_fumigada">
      Bonificar fumigada
    </label>

    <hr>

    <label>ğŸ¤ ComisiÃ³n (%)</label>
    <input type="number" step="0.01" id="g_comision">

    <label>ğŸŒ«ï¸ VolÃ¡til (%)</label>
    <input type="number" step="0.01" id="g_volatil" readonly>

    <hr>

    <button onclick="cerrarGastos()">Cancelar</button>
    <button onclick="aplicarGastos()" style="background:#2e7d32">
      Aplicar gastos
    </button>
  </div>
</div>
</body>
</html>

<script>
let filaOferenteActual = null;

// base humedad por cereal (simple por ahora)
const baseHumedad = {
  "MaÃ­z": 14.6,
  "Trigo": 13.5,
  "Soja": 13.0,
  "Girasol": 9.0
};

// volÃ¡til automÃ¡tico
const volatilPorCereal = {
  "MaÃ­z": 0.3,
  "Trigo": 0.3,
  "Soja": 0.5,
  "Girasol": 0.5
};

function abrirGastos(btn){
  filaOferenteActual = btn.closest("tr");

  // setea volÃ¡til automÃ¡tico
  document.getElementById("g_volatil").value =
    volatilPorCereal["{{ cereal }}"] || 0;

  document.getElementById("modalGastos").style.display = "block";
}

function cerrarGastos(){
  document.getElementById("modalGastos").style.display = "none";
}

function aplicarGastos(){
  const gastos = {
    flete: +g_flete.value || 0,
    contra: +g_contra.value || 0,
    paritarias: +g_paritarias.value || 0,
    secada: +g_secada.value || 0,
    fumigada: bonif_fumigada.checked ? 0 : (+g_fumigada.value || 0),
    zarandeo: +g_zarandeo.value || 0,
    almacenaje: +g_almacenaje.value || 0,
    manipuleo: +g_manipuleo.value || 0,
    bonif_secada: +bonif_secada.value || 0,
    comision: +g_comision.value || 0,
    volatil: +g_volatil.value || 0
  };

  // guardamos todo en la fila
  filaOferenteActual.dataset.gastos = JSON.stringify(gastos);

  const totalFijo =
    gastos.flete +
    gastos.contra +
    gastos.paritarias +
    gastos.fumigada +
    gastos.zarandeo +
    gastos.almacenaje +
    gastos.manipuleo;

  filaOferenteActual
    .querySelector(".total-gastos")
    .innerText = totalFijo.toFixed(2) + " USD/TN";

  cerrarGastos();
}
</script>
